name: micro2
on:
  push:
    branches:
      - 'feature**'
    paths:
      - 'deploy/terraform/micro3/**'

jobs:
  automerge-1:
    name: Merge 'develop -> feature'
    runs-on: ubuntu-latest
    outputs:
      salida: ${{ steps.prepare_release.outputs.respuesta }}
    steps:
      - name: Integrar develop en feature
        uses: tukasz/direct-merge-action@master
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          source-branch: develop
          target-branch: ${{ github.ref }}
          commit-message: "Actualizar rama feature con respecto a rama develop"
      - name: prepare_release
        id: prepare_release
        run: |
          echo "::set-output name=respuesta::$(echo "${{ github.event.head_commit.message }}" | awk '{print $NF}')"

  terraform:
    name: Despliegue Micro 3
    needs: 'automerge-1'
    uses: ./.github/workflows/terraform.yml
    with:
      terraform_directory: deploy/terraform/micro3
      bucket: 'tfstate-proyecto-final'
      key: 'micro3.terraform.tfstate'
    secrets:
      aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      aws-region: ${{ secrets.AWS_REGION }}
      aws-s3-bucket: ${{ secrets.AWS_S3_BUCKET }}

  automerge-2:
    name: Merge 'feature -> develop'
    runs-on: ubuntu-latest
    needs: 'terraform'
    steps:
      - name: Integrar feature en develop
        uses: tukasz/direct-merge-action@master
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          source-branch: ${{ github.ref }}
          target-branch: develop
          commit-message: "Integrar rama feature en develop (crearRelease)"
